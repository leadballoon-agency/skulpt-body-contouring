<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Upload Your Progress Photo | Skulpt</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Camera viewfinder */
        .camera-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
        }
        
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Top controls */
        .top-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: env(safe-area-inset-top) 20px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.3);
        }
        
        .flash-toggle {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .flash-toggle.active {
            background: rgba(255, 204, 0, 0.3);
            color: #FFCC00;
        }
        
        /* Guidance overlay */
        .body-outline {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 420px;
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 100px 100px 60px 60px;
            pointer-events: none;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        .guidance-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        
        .guidance-text h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .guidance-text p {
            font-size: 14px;
            opacity: 0.8;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* Bottom controls */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 10;
        }
        
        .camera-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }
        
        /* Gallery button */
        .gallery-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid white;
            background: #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gallery-btn:active {
            transform: scale(0.9);
        }
        
        .gallery-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Capture button - iOS style */
        .capture-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 4px solid white;
            background: white;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .capture-btn::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border-radius: 50%;
            background: white;
        }
        
        .capture-btn:active {
            transform: scale(0.85);
        }
        
        .capture-btn:active::before {
            background: #E5E5E5;
        }
        
        /* Camera flip button */
        .flip-camera {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .flip-camera:active {
            transform: scale(0.9) rotate(180deg);
            background: rgba(255,255,255,0.3);
        }
        
        /* Photo type selector */
        .photo-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .type-option {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .type-option.active {
            background: #0066CC;
            border-color: #0066CC;
        }
        
        /* Preview screen */
        .preview-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: none;
            z-index: 20;
        }
        
        .preview-screen.active {
            display: block;
        }
        
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .preview-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .preview-btn {
            padding: 14px 32px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preview-btn.retake {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
        }
        
        .preview-btn.use {
            background: #0066CC;
            color: white;
        }
        
        .preview-btn:active {
            transform: scale(0.95);
        }
        
        /* Upload progress */
        .upload-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }
        
        .upload-progress.active {
            display: block;
        }
        
        .progress-circle {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #0066CC;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .progress-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Success screen */
        .success-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0066CC 0%, #0052A3 100%);
            display: none;
            z-index: 30;
            padding: 40px;
            text-align: center;
            justify-content: center;
            align-items: center;
        }
        
        .success-screen.active {
            display: flex;
            flex-direction: column;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            animation: scaleIn 0.5s ease;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .success-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .success-message {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .success-btn {
            background: white;
            color: #0066CC;
            padding: 14px 32px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Native file input (hidden) */
        .file-input {
            display: none;
        }
        
        /* iOS-specific adjustments */
        @supports (-webkit-touch-callout: none) {
            .bottom-controls {
                padding-bottom: calc(40px + env(safe-area-inset-bottom));
            }
        }
        
        /* Android-specific adjustments */
        @media screen and (max-aspect-ratio: 13/9) {
            .body-outline {
                width: 240px;
                height: 360px;
            }
        }
        
        /* Landscape orientation */
        @media screen and (orientation: landscape) {
            .body-outline {
                width: 200px;
                height: 280px;
            }
            
            .camera-controls {
                position: absolute;
                right: 30px;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Camera View -->
    <div class="camera-view">
        <video id="camera-feed" autoplay playsinline></video>
        
        <!-- Top Controls -->
        <div class="top-controls">
            <button class="close-btn" onclick="closeCamera()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                </svg>
            </button>
            
            <button class="flash-toggle" onclick="toggleFlash()" id="flashBtn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M9 2L6 8h3l-1 6 4-7h-3l1-5z"/>
                </svg>
                <span>Off</span>
            </button>
        </div>
        
        <!-- Body Outline Guide -->
        <div class="body-outline"></div>
        <div class="guidance-text">
            <h3>Center yourself</h3>
            <p>Stand 3 feet from camera</p>
        </div>
        
        <!-- Bottom Controls -->
        <div class="bottom-controls">
            <!-- Photo Type Selector -->
            <div class="photo-type-selector">
                <div class="type-option active" onclick="selectType('front')">Front</div>
                <div class="type-option" onclick="selectType('side')">Side</div>
                <div class="type-option" onclick="selectType('back')">Back</div>
            </div>
            
            <!-- Camera Controls -->
            <div class="camera-controls">
                <button class="gallery-btn" onclick="openGallery()">
                    <img src="/api/placeholder/44/44" alt="Gallery" id="lastPhoto">
                </button>
                
                <button class="capture-btn" onclick="capturePhoto()"></button>
                
                <button class="flip-camera" onclick="flipCamera()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 5h-3.2L15 3H9L7.2 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-8 13c-2.8 0-5-2.2-5-5H5l2.5-2.5L10 13H8c0 2.2 1.8 4 4 4 .6 0 1.2-.1 1.7-.4l.7.7c-.7.4-1.5.7-2.4.7zm4.5-2.5L14 13h2c0-2.2-1.8-4-4-4-.6 0-1.2.1-1.7.4l-.7-.7c.7-.4 1.5-.7 2.4-.7 2.8 0 5 2.2 5 5h2l-2.5 2.5z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Preview Screen -->
    <div class="preview-screen" id="previewScreen">
        <img class="preview-image" id="previewImage" alt="Preview">
        
        <div class="preview-controls">
            <button class="preview-btn retake" onclick="retakePhoto()">Retake</button>
            <button class="preview-btn use" onclick="usePhoto()">Use Photo</button>
        </div>
        
        <div class="upload-progress" id="uploadProgress">
            <div class="progress-circle"></div>
            <div class="progress-text">Uploading...</div>
            <div class="progress-subtitle">Securing your photo</div>
        </div>
    </div>
    
    <!-- Success Screen -->
    <div class="success-screen" id="successScreen">
        <div class="success-icon">âœ“</div>
        <h2 class="success-title">Photo Saved!</h2>
        <p class="success-message">
            Your progress photo has been securely saved to your journey timeline.
        </p>
        <button class="success-btn" onclick="finishUpload()">Continue</button>
    </div>
    
    <!-- Hidden file input for gallery -->
    <input type="file" class="file-input" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
    
    <script>
        let stream = null;
        let currentCamera = 'environment'; // rear camera default
        let photoType = 'front';
        let capturedImage = null;
        let flashEnabled = false;
        
        // Initialize camera on load
        window.addEventListener('load', () => {
            initCamera();
            loadLastPhoto();
        });
        
        async function initCamera() {
            try {
                // Request camera permissions
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-feed');
                video.srcObject = stream;
                
                // Check for flash support
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    document.getElementById('flashBtn').style.display = 'flex';
                } else {
                    document.getElementById('flashBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Camera access denied:', error);
                // Fallback to file upload
                openGallery();
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Convert to blob
            canvas.toBlob((blob) => {
                capturedImage = blob;
                const url = URL.createObjectURL(blob);
                
                // Show preview
                document.getElementById('previewImage').src = url;
                document.getElementById('previewScreen').classList.add('active');
                
                // Haptic feedback on iOS
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(10);
                }
            }, 'image/jpeg', 0.92);
            
            // Camera shutter effect
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 100;
                pointer-events: none;
                animation: flash 0.2s ease;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 200);
        }
        
        function retakePhoto() {
            document.getElementById('previewScreen').classList.remove('active');
            capturedImage = null;
        }
        
        async function usePhoto() {
            // Show upload progress
            document.getElementById('uploadProgress').classList.add('active');
            
            // Initialize Cloudinary upload
            const formData = new FormData();
            formData.append('file', capturedImage);
            formData.append('upload_preset', 'skulpt_progress');
            formData.append('folder', `users/${getUserId()}/progress`);
            formData.append('tags', `${photoType},day_${getDayNumber()}`);
            
            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/ddxptienb/image/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Save to database
                await savePhotoMetadata(data);
                
                // Show success
                document.getElementById('uploadProgress').classList.remove('active');
                document.getElementById('previewScreen').classList.remove('active');
                document.getElementById('successScreen').classList.add('active');
                
                // Haptic success feedback
                if (window.navigator.vibrate) {
                    window.navigator.vibrate([50, 30, 50]);
                }
            } catch (error) {
                console.error('Upload failed:', error);
                showError('Upload failed. Please try again.');
            }
        }
        
        function flipCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            // Stop current stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Reinitialize with new camera
            initCamera();
        }
        
        async function toggleFlash() {
            if (!stream) return;
            
            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            if (!capabilities.torch) return;
            
            flashEnabled = !flashEnabled;
            
            await track.applyConstraints({
                advanced: [{ torch: flashEnabled }]
            });
            
            // Update UI
            const flashBtn = document.getElementById('flashBtn');
            flashBtn.classList.toggle('active', flashEnabled);
            flashBtn.querySelector('span').textContent = flashEnabled ? 'On' : 'Off';
        }
        
        function openGallery() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size
            if (file.size > 10 * 1024 * 1024) {
                showError('Please select an image under 10MB');
                return;
            }
            
            capturedImage = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewScreen').classList.add('active');
            };
            reader.readAsDataURL(file);
        }
        
        function selectType(type) {
            photoType = type;
            
            // Update UI
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update guidance based on type
            const guidanceText = document.querySelector('.guidance-text h3');
            if (type === 'side') {
                guidanceText.textContent = 'Turn to your side';
            } else if (type === 'back') {
                guidanceText.textContent = 'Turn around';
            } else {
                guidanceText.textContent = 'Center yourself';
            }
        }
        
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            window.close();
            // Or navigate back
            window.history.back();
        }
        
        function finishUpload() {
            // Return to dashboard or next step
            window.location.href = '/dashboard';
        }
        
        function loadLastPhoto() {
            // Load last photo from localStorage or API
            const lastPhotoUrl = localStorage.getItem('lastPhotoThumb');
            if (lastPhotoUrl) {
                document.getElementById('lastPhoto').src = lastPhotoUrl;
            }
        }
        
        async function savePhotoMetadata(cloudinaryData) {
            const metadata = {
                userId: getUserId(),
                photoId: cloudinaryData.public_id,
                url: cloudinaryData.secure_url,
                thumbnailUrl: cloudinaryData.eager?.[0]?.secure_url || cloudinaryData.secure_url,
                type: photoType,
                dayNumber: getDayNumber(),
                timestamp: new Date().toISOString(),
                dimensions: {
                    width: cloudinaryData.width,
                    height: cloudinaryData.height
                }
            };
            
            // Save to database
            await fetch('/api/photos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(metadata)
            });
            
            // Save thumbnail for gallery button
            localStorage.setItem('lastPhotoThumb', metadata.thumbnailUrl);
        }
        
        function getUserId() {
            return localStorage.getItem('userId') || 'anonymous';
        }
        
        function getDayNumber() {
            const startDate = localStorage.getItem('journeyStartDate');
            if (!startDate) return 1;
            
            const start = new Date(startDate);
            const today = new Date();
            const diffTime = Math.abs(today - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }
        
        function showError(message) {
            // Native-style error toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: absolute;
                top: 100px;
                left: 20px;
                right: 20px;
                background: rgba(255, 59, 48, 0.9);
                color: white;
                padding: 16px;
                border-radius: 12px;
                font-size: 14px;
                text-align: center;
                z-index: 1000;
                animation: slideDown 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes flash {
                0% { opacity: 0; }
                50% { opacity: 1; }
                100% { opacity: 0; }
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>