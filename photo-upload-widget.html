<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skulpt Photo Upload Widget</title>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <style>
        .upload-button {
            background: linear-gradient(135deg, #D4AF37 0%, #E8B4B8 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 1rem;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .photo-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <h1>Upload Your Progress Photos</h1>
        
        <!-- Direct Upload Button -->
        <button class="upload-button" onclick="openWidget()">
            ðŸ“¸ Upload Progress Photo
        </button>
        
        <!-- Camera Capture -->
        <button class="upload-button" onclick="captureFromCamera()">
            ðŸ“· Take Photo Now
        </button>
        
        <!-- Photos Display -->
        <div class="photo-grid" id="photoGrid"></div>
    </div>

    <script>
        // Your Cloudinary configuration
        const CLOUD_NAME = 'YOUR_CLOUD_NAME'; // Replace with your cloud name
        const UPLOAD_PRESET = 'skulpt_journeys'; // Your upload preset
        
        // Initialize the upload widget
        function openWidget() {
            const myWidget = cloudinary.createUploadWidget({
                cloudName: CLOUD_NAME,
                uploadPreset: UPLOAD_PRESET,
                sources: ['local', 'camera', 'url'],
                multiple: false,
                folder: 'skulpt/journeys',
                tags: ['skulpt', 'journey', 'progress'],
                context: {
                    assessment_id: sessionStorage.getItem('assessmentId') || 'test',
                    uploaded_at: new Date().toISOString()
                },
                clientAllowedFormats: ['jpg', 'png', 'webp'],
                maxFileSize: 10000000, // 10MB
                cropping: true,
                croppingAspectRatio: 3/4,
                croppingShowDimensions: true,
                styles: {
                    palette: {
                        window: "#FFFFFF",
                        windowBorder: "#D4AF37",
                        tabIcon: "#D4AF37",
                        menuIcons: "#6B6866",
                        textDark: "#2C2A29",
                        textLight: "#FFFFFF",
                        link: "#D4AF37",
                        action: "#D4AF37",
                        inactiveTabIcon: "#6B6866",
                        error: "#F44235",
                        inProgress: "#D4AF37",
                        complete: "#20B832",
                        sourceBg: "#FFFEF9"
                    },
                    fonts: {
                        default: {
                            active: true
                        }
                    }
                }
            }, (error, result) => {
                if (!error && result && result.event === "success") {
                    console.log('Upload successful:', result.info);
                    
                    // Send to your backend
                    savePhotoToJourney(result.info);
                    
                    // Display the uploaded image
                    displayPhoto(result.info.secure_url, result.info.public_id);
                }
            });
            
            myWidget.open();
        }
        
        // Direct camera capture (mobile optimized)
        function captureFromCamera() {
            // Create input element for camera
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use back camera on mobile
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Convert to base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        // Upload to Cloudinary via your API
                        await uploadViaAPI(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }
        
        // Upload via your API (with server-side processing)
        async function uploadViaAPI(base64Image) {
            try {
                const response = await fetch('/api/cloudinary-upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        assessmentId: sessionStorage.getItem('assessmentId') || 'test',
                        photoType: 'during', // or determine based on journey stage
                        sessionNumber: 3,
                        bodyArea: 'abdomen',
                        angle: 'front'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    displayPhoto(result.imageUrl, result.publicId);
                    
                    // Show comparison if available
                    if (result.comparisonUrl) {
                        alert('Comparison created! Check your journey page.');
                    }
                }
            } catch (error) {
                console.error('Upload failed:', error);
            }
        }
        
        // Save photo metadata to your database
        async function savePhotoToJourney(cloudinaryInfo) {
            try {
                await fetch('/api/visual-journey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assessmentId: sessionStorage.getItem('assessmentId'),
                        cloudinaryUrl: cloudinaryInfo.secure_url,
                        cloudinaryPublicId: cloudinaryInfo.public_id,
                        photoType: 'during',
                        treatmentStage: 'session_3',
                        bodyArea: 'abdomen',
                        angle: 'front'
                    })
                });
            } catch (error) {
                console.error('Failed to save to journey:', error);
            }
        }
        
        // Display uploaded photo
        function displayPhoto(url, publicId) {
            const photoGrid = document.getElementById('photoGrid');
            const photoCard = document.createElement('div');
            photoCard.className = 'photo-card';
            photoCard.innerHTML = `
                <img src="${url}" alt="Progress photo">
                <div style="padding: 0.5rem; font-size: 0.875rem; color: #6B6866;">
                    Uploaded ${new Date().toLocaleDateString()}
                </div>
            `;
            photoGrid.appendChild(photoCard);
        }
    </script>
</body>
</html>